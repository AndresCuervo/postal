#!/bin/sh

die() {
  echo $1 1>&2
  exit 1
}

HERE=`pwd -P`
DATE=`date +%Y%m%d%H%M%S`
VERSION=`git rev-parse HEAD | cut -c-8`

[ "x" == "x$SRC" ] && die "error: please set \$SRC"
[ "x" == "x$MAIN" ] && die "error: please set \$MAIN"
[ "x" == "x$PROJECT" ] && die "error: please set \$PROJECT"
[ "x" == "x$JARHOME" ] && die "error: please set \$JARHOME"
[ "x" == "x$DEST" ] && die "error: please provide jar destination"
[ ! -d $DEST ] && mkdir -p $DEST

CLASSES=classes
BUILD=build
NSCOMPILE=$HERE/etc/compile
JAR=$DEST/$PROJECT-$DATE-$VERSION.jar
JARCOMPILE=$HERE/etc/jars-compile
JARDIST=$HERE/etc/jars-dist

mkdir -p $CLASSES
[ -d $SRC/clj ] && ( cd $SRC/clj; git archive --format tar head . ) | ( cd $CLASSES; tar xf - )
[ -d $SRC/jvm ] && ( cd $SRC/jvm; git archive --format tar head . ) | ( cd $CLASSES; tar xf - )

mkdir -p $BUILD

for jarname in `cat $JARCOMPILE`; do
  jar=$JARHOME/$jarname
  echo Extracting $jar
  ( cd $BUILD; jar xf $jar )
done

for jarname in `cat $JARDIST`; do
  jar=$JARHOME/$jarname
  echo Packaging $jar
  ( cd $CLASSES; jar tvf $jar | egrep '(class|clj)$' | xargs jar xf $jar - )
done

java \
  -cp $BUILD:$CLASSES \
  -Dclojure.compile.path=$CLASSES \
  clojure.lang.Compile \
  `cat $NSCOMPILE | xargs echo` \
&& \
( cd $CLASSES
  jar cfe \
    $JAR \
    $MAIN \
    . ) \
&& rm -rf $CLASSES $BUILD

echo Writing $JAR

